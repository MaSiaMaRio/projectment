<!DOCTYPE html>
<html>
<head>
    <title>–ö–∞—Ä—Ç–∞ –ù–∞–ª—å—á–∏–∫–∞</title>
    <meta charset="utf-8" />
    <style>
        #map { height: 90vh; width: 100%; }
        .comment-box { margin-top: 10px; }
        .comment-input { width: 100%; padding: 4px; }
        .comment-list { margin-top: 5px; font-size: 0.9em; color: #333; max-height: 150px; overflow-y: auto; }
        .comment-item { border-top: 1px solid #ccc; padding: 3px 0; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([43.4847, 43.6071], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        fetch('/get_points').then(res => res.json()).then(data => {
            data.forEach(p => {
                const marker = L.marker([p[1], p[2]]).addTo(map);
                marker.bindTooltip(p[3], { permanent: true, direction: 'top' });

                let popupContent = `<b>${p[3]}</b><br/>Likes: ${p[5]} Dislikes: ${p[6]}<br/>`;
                if (p[4]) popupContent += `<img src="${p[4]}" width="100" /><br/>`;

                popupContent += `
                    <button onclick="like(${p[0]})">üëç</button>
                    <button onclick="dislike(${p[0]})">üëé</button>
                    <div class="comment-box">
                        <input class="comment-input" id="comment_input_${p[0]}" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." />
                        <button onclick="addComment(${p[0]})">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        <div class="comment-list" id="comments_${p[0]}">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</div>
                    </div>
                `;

                marker.bindPopup(popupContent);

                marker.on('popupopen', () => {
                    loadComments(p[0]);
                });
            });
        });

        function like(id) {
            fetch('/like_point/' + id, { method: 'POST' }).then(() => location.reload());
        }

        function dislike(id) {
            fetch('/dislike_point/' + id, { method: 'POST' }).then(() => location.reload());
        }

        function addComment(point_id) {
            const input = document.getElementById('comment_input_' + point_id);
            const text = input.value.trim();
            if (!text) return;
            const formData = new FormData();
            formData.append('point_id', point_id);
            formData.append('text', text);
            fetch('/add_comment', { method: 'POST', body: formData })
                .then(() => {
                    input.value = '';
                    loadComments(point_id);
                });
        }

        function loadComments(point_id) {
            fetch('/get_comments/' + point_id).then(res => res.json()).then(data => {
                const container = document.getElementById('comments_' + point_id);
                if (!data.length) {
                    container.innerHTML = '<i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</i>';
                } else {
                    container.innerHTML = data.map(c => 
                        '<div class="comment-item">' + c[0] + 
                        ' <span style="float:right;font-size:0.8em;color:#888;">' + new Date(c[1]).toLocaleString() + '</span></div>'
                    ).join('');
                }
            });
        }

        map.on('click', function(e) {
            const comment = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–æ—á–∫–µ:');
            if (!comment) return;
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            const formData = new FormData();
            formData.append('lat', lat);
            formData.append('lon', lon);
            formData.append('comment', comment);
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = () => {
                if (fileInput.files[0]) {
                    formData.append('image', fileInput.files[0]);
                }
                fetch('/add_point', { method: 'POST', body: formData })
                    .then(() => location.reload());
            };
            fileInput.click();
        });
    </script>
</body>
</html>
